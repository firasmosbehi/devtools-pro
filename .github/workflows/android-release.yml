name: Android Release

on:
  workflow_dispatch:
    inputs:
      track:
        description: "Play Store track (internal|alpha|beta|production)"
        required: false
        default: internal
      rollout:
        description: "Staged rollout % (production only)"
        required: false
        default: "100"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      ANDROID_KEY_ALIAS_PASSWORD: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
      ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.9'
          cache: true

      - name: Decode upload keystore
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 -d > android/app/upload-keystore.jks
          cat <<'EOF' > android/key.properties
          storePassword=${ANDROID_KEYSTORE_PASSWORD}
          keyPassword=${ANDROID_KEY_ALIAS_PASSWORD}
          keyAlias=${ANDROID_KEY_ALIAS}
          storeFile=upload-keystore.jks
          EOF

      - name: Generate fallback debug keystore
        if: ${{ env.ANDROID_KEYSTORE_BASE64 == '' }}
        run: |
          mkdir -p ~/.config/.android
          keytool -genkeypair -v \
            -storetype PKCS12 \
            -keystore ~/.config/.android/debug.keystore \
            -alias androiddebugkey \
            -storepass android \
            -keypass android \
            -dname "CN=Android Debug,O=Android,C=US" \
            -validity 10000

      - name: Flutter pub get
        run: flutter pub get

      - name: Run tests
        run: flutter test --coverage

      - name: Build app bundle
        run: flutter build appbundle --release

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: build/app/outputs/bundle/release/app-release.aab
  
  deploy:
    needs: build
    env:
      PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
    runs-on: ubuntu-latest
    steps:
      - name: Skip deploy if secret missing
        if: ${{ env.PLAY_SERVICE_ACCOUNT_JSON == '' }}
        run: echo "PLAY_SERVICE_ACCOUNT_JSON is not set; skipping deploy."

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.9'
          cache: true

      - name: Download AAB from build job
        uses: actions/download-artifact@v4
        with:
          name: app-release-aab
          path: build/app/outputs/bundle/release

      - name: Install fastlane supply (Play publishing)
        run: sudo gem install fastlane -N

      - name: Write service account json
        run: |
          mkdir -p android/play
          echo "$PLAY_SERVICE_ACCOUNT_JSON" > android/play/service-account.json
        env:
          PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}

      - name: Publish to Google Play
        env:
          SUPPLY_PACKAGE_NAME: com.devtoolspro.devtools_pro
          SUPPLY_JSON_KEY: android/play/service-account.json
          SUPPLY_AAB_FILE: build/app/outputs/bundle/release/app-release.aab
          SUPPLY_TRACK: ${{ github.event.inputs.track || 'internal' }}
          SUPPLY_ROLLOUT_PERCENTAGE: ${{ github.event.inputs.rollout }}
        run: |
          TRACK="$SUPPLY_TRACK"
          ROLLOUT_FLAG=""
          if [ "$TRACK" = "production" ] && [ -n "$SUPPLY_ROLLOUT_PERCENTAGE" ]; then
            ROLLOUT_FLAG="--rollout $SUPPLY_ROLLOUT_PERCENTAGE"
          fi
          fastlane supply \
            --package_name "$SUPPLY_PACKAGE_NAME" \
            --json_key "$SUPPLY_JSON_KEY" \
            --aab "$SUPPLY_AAB_FILE" \
            --track "$TRACK" \
            $ROLLOUT_FLAG

      - name: Cleanup service account
        if: always()
        run: rm -f android/play/service-account.json
